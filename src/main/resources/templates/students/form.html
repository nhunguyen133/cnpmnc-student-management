<html
  xmlns:th="http://www.thymeleaf.org"
  th:replace="~{fragments/layout :: page(${isEdit ? 'Sửa Thông Tin' : 'Thêm Sinh Viên'}, ~{::section})}"
>
  <section>
    <div class="mb-4">
      <a
        th:href="@{/students}"
        class="btn btn-light-subtle btn-sm rounded-pill px-3 py-2 fw-medium"
      >
        <i class="bi bi-arrow-left me-1"></i> Hủy và quay lại
      </a>
    </div>

    <div class="card card-normal col-md-8 col-lg-6 mx-auto border-0 p-4">
      <div class="card-body">
        <h3
          class="fw-bold mb-2 text-dark"
          th:text="${isEdit ? 'Cập nhật thông tin' : 'Thêm hồ sơ mới'}"
        ></h3>
        <p class="text-muted mb-4">
          Vui lòng điền đầy đủ và chính xác các thông tin bên dưới.
        </p>

        <!-- Error Message -->
        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          <span th:text="${error}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Success Message -->
        <div th:if="${message}" class="alert alert-success alert-dismissible fade show" role="alert">
          <i class="bi bi-check-circle-fill me-2"></i>
          <span th:text="${message}"></span>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <form
          th:action="${isEdit ? '/students/' + student.id + '/edit' : '/students/new'}"
          th:object="${student}"
          method="post"
        >
          <input type="hidden" id="originalId" th:value="${student.id}" />
          <div class="mb-4">
            <label class="form-label">Mã sinh viên <span class="text-danger">*</span></label>
            <input
              type="text"
              class="form-control form-control-lg"
              th:field="*{id}"
              placeholder="Ví dụ: SV001"
              required
              pattern="^[A-Z0-9]{3,10}$"
              title="Mã sinh viên phải từ 3-10 ký tự (chữ in hoa và số)"
            />
            <div class="form-text">
              Mã sinh viên phải từ 3-10 ký tự, chỉ bao gồm chữ in hoa (A-Z) và số (0-9)
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label">Họ và Tên <span class="text-danger">*</span></label>
            <input
              type="text"
              class="form-control form-control-lg"
              th:field="*{name}"
              placeholder="Ví dụ: Nguyễn Văn A"
              required
              minlength="3"
              maxlength="100"
              title="Họ tên phải từ 3-100 ký tự"
            />
            <div class="form-text">
              Nhập họ và tên đầy đủ (3-100 ký tự)
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label">Địa chỉ Email <span class="text-danger">*</span></label>
            <input
              type="email"
              class="form-control form-control-lg"
              th:field="*{email}"
              placeholder="example@hcmut.edu.vn"
              required
              pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
              title="Email không hợp lệ"
            />
            <div class="form-text">
              Nhập email hợp lệ (ví dụ: student@example.com)
            </div>
          </div>

          <div class="mb-4">
            <label class="form-label">Độ tuổi <span class="text-danger">*</span></label>
            <input
              type="number"
              class="form-control form-control-lg"
              th:field="*{age}"
              placeholder="Nhập độ tuổi hợp lệ..."
              required
              min="1"
              max="150"
              title="Tuổi phải từ 1 đến 150"
            />
            <div class="form-text">
              Nhập tuổi hợp lệ (1-150)
            </div>
          </div>

          <div class="d-grid mt-4">
            <button
              type="submit"
              class="btn btn-primary btn-lg rounded-pill fw-semibold py-3"
            >
              Lưu thông tin hồ sơ
            </button>
          </div>
        </form>
        <script th:inline="javascript">
          /*<![CDATA[*/
          (function () {
            const isEdit = /*[[${isEdit}]]*/ false;
            if (!isEdit) return;

            const form = document.currentScript.previousElementSibling; // the form
            const originalIdInput = document.getElementById("originalId");
            const originalId = originalIdInput ? originalIdInput.value : "";
            const idField = form.querySelector('[name="id"]');

            form.addEventListener("submit", async function (e) {
              const newId = idField ? idField.value.trim() : "";
              // if id unchanged or empty, proceed with normal submit to update
              if (!originalId || newId === "" || newId === originalId) {
                return; // allow default submit
              }

              e.preventDefault();
              const submitBtn = form.querySelector('button[type="submit"]');
              submitBtn.disabled = true;

              try {
                // 1) check if newId already exists via REST API
                const check = await fetch(
                  "/api/students/" + encodeURIComponent(newId),
                  { method: "GET" },
                );
                // The API returns 200 with empty/null body when not found.
                // Read the response text to determine existence reliably.
                const checkText = await check.text();
                if (
                  check.ok &&
                  checkText &&
                  checkText.trim() !== "" &&
                  checkText.trim() !== "null"
                ) {
                  alert("Mã sinh viên đã tồn tại. Vui lòng chọn mã khác.");
                  submitBtn.disabled = false;
                  return;
                }

                // 2) create new student by POSTing the same form data to /students/new
                const formData = new FormData(form);
                // ensure id field has newId
                formData.set("id", newId);

                const createRes = await fetch("/students/new", {
                  method: "POST",
                  body: formData,
                  credentials: "same-origin",
                });

                if (!createRes.ok) {
                  alert("Không thể tạo hồ sơ mới. Vui lòng thử lại.");
                  submitBtn.disabled = false;
                  return;
                }

                // 3) delete old student
                const delRes = await fetch(
                  "/students/" + encodeURIComponent(originalId) + "/delete",
                  {
                    method: "POST",
                    credentials: "same-origin",
                  },
                );

                // ignore delRes.ok check for now; redirect to new student page
                window.location.href = "/students/" + encodeURIComponent(newId);
              } catch (err) {
                console.error(err);
                alert("Lỗi khi cập nhật mã sinh viên.");
                submitBtn.disabled = false;
              }
            });
          })();
          /*]]>*/
        </script>
      </div>
    </div>
  </section>
</html>
